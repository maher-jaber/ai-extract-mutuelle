<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traitement PDF Mutuelle</title>
    <style>
        :root {
            --primary-color: #3498db;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .upload-section {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 20px 0;
        }

        .file-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 24px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .file-input-label:hover {
            background-color: #2980b9;
        }

        .process-btn {
            padding: 12px 24px;
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            margin-top: 10px;
        }

        .process-btn:hover {
            background-color: #27ae60;
        }

        .process-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            margin-top: 20px;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .results-section {
            display: none;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .confidence-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .confidence-low {
            background-color: var(--danger-color);
            color: white;
        }

        .confidence-medium {
            background-color: var(--warning-color);
            color: white;
        }

        .confidence-high {
            background-color: var(--success-color);
            color: white;
        }

        .accordion {
            margin-top: 20px;
        }

        .accordion-item {
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .accordion-header {
            padding: 15px;
            background-color: var(--light-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .accordion-header:hover {
            background-color: #e9ecef;
        }

        .accordion-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .accordion-content.active {
            max-height: 500px;
            padding: 15px;
            overflow-y: auto;
        }

        .beneficiary-info {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .prestation-item {
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
            border-left: 4px solid var(--primary-color);
        }

        .prestation-code {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 16px;
            margin-bottom: 8px;
        }

        .prestation-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .prestation-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }

        .prestation-detail {
            font-size: 14px;
        }

        .prestation-detail strong {
            color: #333;
        }

        .note-badge {
            display: inline-block;
            background-color: var(--warning-color);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-top: 5px;
        }

        .note-description {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 10px;
            margin-top: 8px;
            font-size: 13px;
            color: #856404;
        }

        .extra-descriptions {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ddd;
        }

        .extra-description {
            font-size: 12px;
            color: #666;
            margin-bottom: 3px;
        }

        .json-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 4px;
            margin-top: 30px;
        }

        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            background-color: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }

        .error-message {
            color: var(--danger-color);
            margin-top: 10px;
            padding: 10px;
            background-color: #ffeaea;
            border-radius: 4px;
            display: none;
        }

        footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Traitement de PDF Mutuelle</h1>
            <p>Téléchargez votre PDF de mutuelle pour obtenir les informations structurées</p>
        </header>
        <section class="upload-section" id="loginSection">
            <h2>Étape 0 : Connexion</h2>
            <input type="text" id="username" placeholder="Nom d'utilisateur">
            <input type="password" id="password" placeholder="Mot de passe">
            <button id="loginBtn" class="process-btn">Se connecter</button>
            <div class="error-message" id="loginError"></div>
        </section>
        <section class="upload-section">
            <h2>Étape 1 : Sélectionnez votre PDF</h2>
            <div class="file-input-wrapper">
                <input type="file" id="pdfFile" class="file-input" accept=".pdf">
                <label for="pdfFile" class="file-input-label">Choisir un fichier PDF</label>
            </div>
            <p id="fileName">Aucun fichier sélectionné</p>

            <button id="processBtn" class="process-btn" disabled>Traiter le PDF</button>

            <div class="loading" id="loadingIndicator">
                <div class="spinner"></div>
                <p>Traitement en cours...</p>
            </div>

            <div class="error-message" id="errorMessage"></div>
        </section>

        <section class="results-section" id="resultsSection">
            <h2>Résultats du traitement</h2>

            <div id="confidenceBadge" class="confidence-badge"></div>

            <div class="accordion" id="resultsAccordion">
                <!-- Les résultats seront insérés ici dynamiquement -->
            </div>

            <div class="json-section">
                <h3>Données JSON complètes</h3>
                <pre id="jsonOutput"></pre>
            </div>
        </section>

        <footer>
            <p>Application de traitement de PDF Mutuelle &copy; 2023</p>
        </footer>
    </div>

    <script>
        let accessToken = null;  // Stockera le JWT

        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');

        loginBtn.addEventListener('click', function () {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            fetch('http://192.168.24.94/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.access_token) {
                        accessToken = data.access_token;
                        loginError.style.display = 'none';
                        alert('Connexion réussie ! Vous pouvez maintenant traiter le PDF.');
                    } else if (data.error) {
                        loginError.textContent = data.error;
                        loginError.style.display = 'block';
                    }
                })
                .catch(err => {
                    loginError.textContent = 'Erreur lors de la connexion.';
                    loginError.style.display = 'block';
                    console.error(err);
                });
        });
        document.addEventListener('DOMContentLoaded', function () {
            const pdfFileInput = document.getElementById('pdfFile');
            const fileNameDisplay = document.getElementById('fileName');
            const processBtn = document.getElementById('processBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const resultsSection = document.getElementById('resultsSection');
            const resultsAccordion = document.getElementById('resultsAccordion');
            const jsonOutput = document.getElementById('jsonOutput');
            const errorMessage = document.getElementById('errorMessage');
            const confidenceBadge = document.getElementById('confidenceBadge');

            // Gestion de la sélection de fichier
            pdfFileInput.addEventListener('change', function () {
                if (this.files.length > 0) {
                    fileNameDisplay.textContent = this.files[0].name;
                    processBtn.disabled = false;
                    errorMessage.style.display = 'none';
                } else {
                    fileNameDisplay.textContent = 'Aucun fichier sélectionné';
                    processBtn.disabled = true;
                }
            });

            // Traitement du PDF
            processBtn.addEventListener('click', function () {
                if (pdfFileInput.files.length === 0) {
                    showError('Veuillez sélectionner un fichier PDF');
                    return;
                }

                const file = pdfFileInput.files[0];

                // Afficher l'indicateur de chargement
                loadingIndicator.style.display = 'block';
                processBtn.disabled = true;
                errorMessage.style.display = 'none';

                // Préparer les données pour l'API
                const formData = new FormData();
                formData.append('file', file);

                // Appeler l'API
                fetch('http://192.168.24.94/api/process', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`  // <- ajout du token
                    },
                    body: formData
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Erreur HTTP: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Cacher l'indicateur de chargement
                        loadingIndicator.style.display = 'none';
                        processBtn.disabled = false;

                        // Vérifier si l'API a retourné une erreur
                        if (data.error) {
                            throw new Error(data.error);
                        }

                        // Afficher les résultats
                        displayResults(data);
                    })
                    .catch(error => {
                        // Cacher l'indicateur de chargement
                        loadingIndicator.style.display = 'none';
                        processBtn.disabled = false;

                        // Afficher l'erreur
                        if (error.message.includes("CUDA out of memory")) {
                            showError("Un autre traitement est en cours, veuillez réessayer plus tard.");
                        } else {
                            showError(`Erreur lors du traitement: ${error.message}`);
                        }
                        console.error('Erreur:', error);
                    });
            });

            // Fonction pour afficher les erreurs
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
            }

            // Fonction pour afficher les résultats
            function displayResults(data) {
                // Afficher la section des résultats
                resultsSection.style.display = 'block';

                // Afficher le badge de confiance
                const confidence = data.confidence || 0;
                const confidencePercentage = Math.round(confidence * 100);

                let confidenceClass = 'confidence-low';
                if (confidence >= 0.7) {
                    confidenceClass = 'confidence-high';
                } else if (confidence >= 0.5) {
                    confidenceClass = 'confidence-medium';
                }

                confidenceBadge.className = `confidence-badge ${confidenceClass}`;
                confidenceBadge.textContent = `Confiance: ${confidencePercentage}%`;

                // Afficher les informations principales
                let accordionHTML = `
                    <div class="accordion-item">
                        <div class="accordion-header" onclick="toggleAccordion(this)">
                            <span>Informations principales</span>
                            <span>+</span>
                        </div>
                        <div class="accordion-content">
                            <div class="beneficiary-info">
                                <p><strong>Nom complet:</strong> ${data.nom_complet || 'Non spécifié'}</p>
                                <p><strong>Numéro de sécurité sociale:</strong> ${data.numero_securite_sociale || 'Non spécifié'}</p>
                                <p><strong>Date de naissance:</strong> ${data.date_naissance || 'Non spécifié'}</p>
                                <p><strong>Numéro d'adhérent:</strong> ${data.numero_adherent || 'Non spécifié'}</p>
                                <p><strong>Numéro AMC:</strong> ${data.numero_amc || 'Non spécifié'}</p>
                                <p><strong>Période de validité:</strong> ${data.date_debut_validite || 'Non spécifié'} - ${data.date_fin_validite || 'Non spécifié'}</p>
                                <p><strong>Méthode d'extraction:</strong> ${data.extraction_method || 'Non spécifié'}</p>
                            </div>
                        </div>
                    </div>
                `;

                // Afficher les bénéficiaires
                if (data.beneficiaires && data.beneficiaires.length > 0) {
                    data.beneficiaires.forEach((beneficiary, index) => {
                        let prestationsHTML = '';

                        if (beneficiary.prestations && beneficiary.prestations.length > 0) {
                            beneficiary.prestations.forEach(prestation => {
                                let extraDescriptionsHTML = '';
                                // Afficher extra_descriptions seulement si elles existent et ne sont pas null
                                if (prestation.extra_descriptions && prestation.extra_descriptions.length > 0) {
                                    extraDescriptionsHTML = `
                                        <div class="extra-descriptions">
                                            ${prestation.extra_descriptions.map(desc =>
                                        `<div class="extra-description">${desc}</div>`
                                    ).join('')}
                                        </div>
                                    `;
                                }

                                let noteHTML = '';
                                // Afficher note et note_description seulement si elles ne sont pas null
                                if (prestation.note !== null && prestation.note !== undefined) {
                                    noteHTML = `
                                        <div class="note-badge">Note: ${prestation.note}</div>
                                    `;

                                    // Afficher note_description seulement si elle n'est pas null
                                    if (prestation.note_description !== null && prestation.note_description !== undefined) {
                                        noteHTML += `
                                            <div class="note-description">${prestation.note_description}</div>
                                        `;
                                    }
                                }

                                prestationsHTML += `
                                    <div class="prestation-item">
                                        <div class="prestation-code">${prestation.code || 'N/A'}</div>
                                        <div class="prestation-label">${prestation.description || 'Non spécifié'}</div>
                                        <div class="prestation-details">
                                            <div class="prestation-detail">
                                                <strong>Valeur:</strong> ${prestation.valeur || 'Non spécifié'}
                                            </div>
                                            <div class="prestation-detail">
                                                <strong>Label:</strong> ${prestation.label || 'Non spécifié'}
                                            </div>
                                        </div>
                                        ${extraDescriptionsHTML}
                                        ${noteHTML}
                                    </div>
                                `;
                            });
                        }

                        accordionHTML += `
                            <div class="accordion-item">
                                <div class="accordion-header" onclick="toggleAccordion(this)">
                                    <span>Bénéficiaire: ${beneficiary.nom_complet || 'Non spécifié'}</span>
                                    <span>+</span>
                                </div>
                                <div class="accordion-content">
                                    <div class="beneficiary-info">
                                        <p><strong>Nom complet:</strong> ${beneficiary.nom_complet || 'Non spécifié'}</p>
                                        <p><strong>Date de naissance:</strong> ${beneficiary.date_naissance || 'Non spécifié'}</p>
                                    </div>
                                    <h4>Prestations</h4>
                                    ${prestationsHTML}
                                </div>
                            </div>
                        `;
                    });
                }

                resultsAccordion.innerHTML = accordionHTML;

                // Afficher le JSON complet
                jsonOutput.textContent = JSON.stringify(data, null, 2);

                // Faire défiler jusqu'aux résultats
                resultsSection.scrollIntoView({ behavior: 'smooth' });
            }
        });

        // Fonction pour gérer l'accordéon
        function toggleAccordion(header) {
            const content = header.nextElementSibling;
            const isActive = content.classList.contains('active');

            // Fermer tous les autres éléments d'accordéon
            document.querySelectorAll('.accordion-content').forEach(item => {
                item.classList.remove('active');
            });

            document.querySelectorAll('.accordion-header span:last-child').forEach(item => {
                item.textContent = '+';
            });

            // Ouvrir/fermer l'élément actuel
            if (!isActive) {
                content.classList.add('active');
                header.querySelector('span:last-child').textContent = '-';
            }
        }
    </script>
</body>

</html>